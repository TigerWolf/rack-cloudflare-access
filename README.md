# Rack::CloudflareAccess

This is a rack middleware to add Cloudflare access to your application. This
means that you can turn on SSO with [Cloudflare Zero
Trust](https://developers.cloudflare.com/cloudflare-one/) and ensure all
requests to your application are authenticated.

This middleware is also designed to work with Rails and to raise an error that
is captured by Rails error handling if any part of the process fails.

## Installation

Install the gem and add to the application's Gemfile by executing:

    $ bundle add rack-cloudflare-access

If bundler is not being used to manage dependencies, install the gem by executing:

    $ gem install rack-cloudflare-access

## Usage

### Authenticating Users

You will need to have a Cloudflare the team url and AUD
([audience](https://datatracker.ietf.org/doc/html/rfc7519#section-4.1.3)). You
can follow the [Cloudflare Zero Trust Getting Started
Guide](https://developers.cloudflare.com/cloudflare-one/setup/#start-from-the-cloudflare-dashboard)
followed by the [Validating JSON
guide](https://developers.cloudflare.com/cloudflare-one/identity/users/validating-json/#programmatic-verification)
in order to get your AUD.

In order to retreive your AUD you will need to decrypt a JWT token generated by
Cloudflare for your application. It used to be possible to access this from your
Cloudflare Dashboard but I can no longer find it. An AUD is required to ensure
tokens from other applcations are not used to access your application.

[add how to get AUD or contact support]

Once you have these, you can add the middleware to your Rack application. In
rails you can create an initializer:

config/initializers/cloudflare_access.rb
```
Rails.application.config.middleware.use(Rack::CloudflareAccess::Middleware, <teams_url>, <AUD>)
```

Rack, in your config.ru file add:
```
use(Rack::CloudflareAccess::Middleware, <teams_url>, <AUD>)
```

Replace the AUD and the teams_url with those from Cloudflare.

### Authorising and Identifying Users

* Here is how you can find the subject
* Email - can change.


## Development

After checking out the repo, run `bin/setup` to install dependencies. Then, run `rake spec` to run the tests. You can also run `bin/console` for an interactive prompt that will allow you to experiment.

To install this gem onto your local machine, run `bundle exec rake install`. To release a new version, update the version number in `version.rb`, and then run `bundle exec rake release`, which will create a git tag for the version, push git commits and the created tag, and push the `.gem` file to [rubygems.org](https://rubygems.org).

## Contributing

Bug reports and pull requests are welcome on GitHub at https://github.com/TigerWolf/rack-cloudflare-access. This project is intended to be a safe, welcoming space for collaboration, and contributors are expected to adhere to the [code of conduct](https://github.com/TigerWolf/rack-cloudflare-access/blob/master/CODE_OF_CONDUCT.md).

## License

The gem is available as open source under the terms of the [MIT License](https://opensource.org/licenses/MIT).

## Code of Conduct

Everyone interacting in the Rack::Cloudflare::Access project's codebases, issue trackers, chat rooms and mailing lists is expected to follow the [code of conduct](https://github.com/TigerWolf/rack-cloudflare-access/blob/master/CODE_OF_CONDUCT.md).


# Future improvements and features

* Allow for urls to be filtered out (e.g. login)
* More efficient HTTP library for getting the certs - for now just keep it simple
* Better rails integration? .present? and deep_symbolize_keys! could use quite useful
